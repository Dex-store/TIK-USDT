<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>لوحة التحكم • TIK-USDT</title>

<style>
body{margin:0;font-family:system-ui;background:radial-gradient(1200px 600px at 50% -10%, #1b255a, #060913);color:#eaf0ff}
.wrap{max-width:1150px;margin:0 auto;padding:18px}
.topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;
background:rgba(12,18,45,.75);border:1px solid rgba(255,255,255,.08);border-radius:22px;padding:14px 16px}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:44px;height:44px;border-radius:16px;background:linear-gradient(135deg,#5b8cff,#7c5cff);
display:flex;align-items:center;justify-content:center;font-weight:900}
.btn{padding:11px 14px;border-radius:16px;border:1px solid rgba(255,255,255,.12);
background:rgba(255,255,255,.04);color:#eaf0ff;font-weight:800;cursor:pointer;text-decoration:none}
.btn.primary{background:linear-gradient(135deg,#5b8cff,#7c5cff);border-color:transparent}
.btn.danger{background:rgba(255,90,120,.14);border-color:rgba(255,90,120,.35)}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:14px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.card{background:rgba(12,18,45,.75);border:1px solid rgba(255,255,255,.08);border-radius:22px;padding:16px}
.h{font-weight:900}
.v{font-weight:900;font-size:22px;margin-top:6px}
.muted{color:#a8b3cf;font-size:13px}
.pill{display:inline-flex;gap:8px;padding:7px 10px;border-radius:999px;border:1px dashed rgba(255,255,255,.16);margin-top:10px}
.dot{width:10px;height:10px;border-radius:99px;background:#999}
.ok{background:#2cff8f}
.warn{background:#ffcc66}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
.kpi{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
.kpi .box{border:1px solid rgba(255,255,255,.10);border-radius:18px;padding:12px;background:rgba(255,255,255,.03)}
</style>
</head>

<body>
<div class="wrap">

<!-- ===== TOP BAR ===== -->
<div class="topbar">
  <div class="brand">
    <div class="logo">T</div>
    <div>
      <div style="font-weight:900">TIK-USDT</div>
      <div class="muted">لوحة التحكم</div>
    </div>
  </div>

  <div style="display:flex;gap:10px;flex-wrap:wrap">
    <a class="btn" href="./plans.html">الاشتراكات</a>
    <a class="btn" href="./referrals.html">إحالاتي</a>
    <a class="btn" href="./commissions.html">عمولاتي</a>
    <a class="btn" href="./withdraw-history.html">سجل السحوبات</a>
    <a class="btn" href="https://t.me/TIK_USDT" target="_blank">الدعم</a>
    <button class="btn danger" id="logoutBtn">خروج</button>
  </div>
</div>

<!-- ===== INFO GRID ===== -->
<div class="grid">

  <div class="card">
    <div class="h">حالة الاشتراك</div>
    <div class="pill">
      <span class="dot warn" id="subDot"></span>
      <span id="subTxt">جارٍ التحميل…</span>
    </div>
    <div class="muted" id="subInfo"></div>
  </div>

  <div class="card">
    <div class="h">الخطة الحالية</div>
    <div class="v" id="planTxt">—</div>
    <div class="muted" id="planInfo">—</div>
  </div>

  <div class="card">
    <div class="h">رصيدك (Balances)</div>
    <div class="kpi">
      <div class="box">
        <div class="muted">متاح</div>
        <div class="v" id="availTxt">0.00</div>
      </div>
      <div class="box">
        <div class="muted">معلّق</div>
        <div class="v" id="lockedTxt">0.00</div>
      </div>
    </div>
    <div class="muted" style="margin-top:8px">USDT (رصيد افتراضي)</div>
  </div>

</div>

<!-- ===== REFERRAL ===== -->
<div class="card" style="margin-top:14px">
  <div class="h">رابط الدعوة</div>
  <div class="pill"><b>refCode:</b> <span class="mono" id="refCodeTxt">—</span></div>
  <input id="refLink" readonly class="mono">
  <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
    <button class="btn primary" id="copyRefBtn">نسخ الرابط</button>
    <a class="btn" id="openRefBtn" target="_blank">فتح الرابط</a>
  </div>
</div>

<!-- ===== WITHDRAW ===== -->
<div class="card" style="margin-top:14px">
  <div class="h">السحب</div>
  <div class="muted" id="wdHint">جارٍ التحميل…</div>
  <div style="margin-top:10px">
    <a class="btn primary" id="withdrawBtn" href="./withdraw-request.html">طلب سحب</a>
  </div>
</div>

</div>

<script src="https://unpkg.com/parse/dist/parse.min.js"></script>
<script src="./config.js"></script>

<script>
Parse.initialize(window.TIK.PARSE_APP_ID, window.TIK.PARSE_JS_KEY);
Parse.serverURL = window.TIK.PARSE_SERVER_URL;

const user = Parse.User.current();
if(!user) location.href="../auth/login.html";

// logout
logoutBtn.onclick = async ()=>{
  await Parse.User.logOut();
  location.href="../auth/login.html";
};

// referral link
const refCode = user.get("refCode") || "";
refCodeTxt.textContent = refCode || "—";
const link = location.origin + "/TIK-USDT/auth/signup.html?ref=" + encodeURIComponent(refCode);
refLink.value = link;
openRefBtn.href = link;
copyRefBtn.onclick = ()=>navigator.clipboard.writeText(link);

// helpers
function safeNum(n){ n=Number(n); return Number.isFinite(n)?n:0; }

// load subscription
async function loadProfile(){
  const Profile = Parse.Object.extend("Profile");
  const q = new Parse.Query(Profile);
  q.equalTo("user", user);
  const p = await q.first();

  if(p && p.get("isActive")){
    subTxt.textContent="نشط";
    subDot.className="dot ok";
    planTxt.textContent=(p.get("planAmount")||"—")+" USDT";
    wdHint.textContent="✅ يمكنك السحب مرة واحدة أسبوعيًا";
    withdrawBtn.style.pointerEvents="auto";
    withdrawBtn.style.opacity=1;
  }else{
    subTxt.textContent="غير مفعل";
    subDot.className="dot warn";
    wdHint.textContent="⛔ لا يمكن السحب قبل التفعيل";
    withdrawBtn.style.pointerEvents="none";
    withdrawBtn.style.opacity=.5;
  }
}

// load balances
async function loadBalances(){
  const Balances = Parse.Object.extend("Balances");
  const q = new Parse.Query(Balances);
  q.equalTo("user", user);
  let b = await q.first();

  if(!b){
    b = new Balances();
    b.set("user", user);
    b.set("available", 0);
    b.set("locked", 0);
    await b.save();
  }

  availTxt.textContent = safeNum(b.get("available")).toFixed(2);
  lockedTxt.textContent = safeNum(b.get("locked")).toFixed(2);
}

(async()=>{
  await loadProfile();
  await loadBalances();
})();
</script>
</body>
</html>
